<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>House/M - Control de Hogar Inteligente</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="../CSS/seguridad.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Estilo r√°pido para que se vea bien la tabla */
    body { font-family: 'Poppins', sans-serif; background: #f4f4f4; padding: 20px; }
    h2 { text-align: center; margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; background: white; }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: left; }
    button { padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer; }
    .aprobar { background-color: #28a745; color: white; }
    .rechazar { background-color: #dc3545; color: white; }
    .empty { text-align: center; color: #555; }
  </style>
</head>
<body>

  <div class="container">
      <h2>Solicitudes de Registro Pendientes</h2>

      <table>
          <thead>
              <tr>
                  <th>Nombre</th>
                  <th>Correo</th>
                  <th>Contrase√±a</th>
                  <th>Acci√≥n</th>
              </tr>
          </thead>
          <tbody id="tablaSolicitudes">
            <!-- Aqu√≠ se insertar√°n din√°micamente las solicitudes -->
          </tbody>
      </table>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js";

    // üîπ Configuraci√≥n Supabase
    const supabaseUrl = "https://qvxfwuxfcvjxmawvzioe.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF2eGZ3dXhmY3ZqeG1hd3Z6aW9lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNTM2MDUsImV4cCI6MjA3NzkyOTYwNX0.stfGausY-BLG_SA8RBiVo4KJYh2fjcXeEpOL6_cJ5nE";
    const supabase = createClient(supabaseUrl, supabaseKey);

    const tabla = document.querySelector("#tablaSolicitudes");

    // üîπ Cargar solicitudes pendientes
    async function cargarSolicitudes() {
      const { data, error } = await supabase
        .from("solicitudes_registro")
        .select("*")
        .eq("estado", "pendiente");

      tabla.innerHTML = "";

      if (error) {
        console.error("Error cargando solicitudes:", error);
        tabla.innerHTML = `<tr><td colspan="4" class="empty">Error al cargar solicitudes</td></tr>`;
        return;
      }

      if (!data || data.length === 0) {
        tabla.innerHTML = `<tr><td colspan="4" class="empty">No hay solicitudes pendientes</td></tr>`;
        return;
      }

      data.forEach(s => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${s.nombre}</td>
          <td>${s.correo}</td>
          <td>${s.contrasena}</td>
          <td>
            <button class="aprobar" onclick="aprobar(${s.id})">Aprobar</button>
            <button class="rechazar" onclick="rechazar(${s.id})">Rechazar</button>
          </td>
        `;
        tabla.appendChild(row);
      });
    }

    // üîπ Aprobar solicitud
    window.aprobar = async (id) => {
      const { error } = await supabase
        .from("solicitudes_registro")
        .update({ estado: "aprobado" })
        .eq("id", id);

      if (error) {
        console.error("Error al aprobar:", error);
        alert("‚ùå Error al aprobar la solicitud.");
        return;
      }

      alert("‚úÖ Solicitud aprobada y usuario creado autom√°ticamente.");
      cargarSolicitudes();
    };

    // üîπ Rechazar solicitud
    window.rechazar = async (id) => {
      const { error } = await supabase
        .from("solicitudes_registro")
        .update({ estado: "rechazado" })
        .eq("id", id);

      if (error) {
        console.error("Error al rechazar:", error);
        alert("‚ùå Error al rechazar la solicitud.");
        return;
      }

      alert("üö´ Solicitud rechazada.");
      cargarSolicitudes();
    };

    // üîπ Cargar solicitudes al inicio
    cargarSolicitudes();
  </script>

</body>
</html>
